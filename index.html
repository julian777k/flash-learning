<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Flash Learning â€” PWA + TTS</title>

  <!-- í˜„ì¬ íŒŒì¼ëª…ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš© -->
  <link rel="manifest" href="manifest.webmanifest.json">
  <link rel="icon" href="icon-192.png" />
  <meta name="theme-color" content="#0f0f12" />

  <style>
    :root{
      --bg:#0f1116; --fg:#e6e6e6; --muted:#9aa0a6; --accent:#4c8bf5; --card:#141821;
      --kw:#111; --mean:#111; --usage:#111;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    h1{font-size:24px;margin:0 0 16px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,button,input[type="range"]{
      background:#1b2130;border:1px solid #2a3246;color:var(--fg);border-radius:10px;
      padding:8px 10px;font-size:14px;outline:none
    }
    button{cursor:pointer}
    .hint{color:var(--muted);font-size:13px;margin:12px 0}
    .bar{height:8px;background:#1e2636;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:var(--accent);width:0%}
    .sp{flex:1}
    .grid{margin-top:14px;display:grid;gap:12px}
    .card{
      background:var(--card); border:1px solid #2a3246;border-radius:16px;
      padding:22px; min-height:70px; display:flex; align-items:center; justify-content:center;
      text-align:center; line-height:1.45; white-space:pre-wrap; word-break:break-word
    }
    .kw   {font-size:42px;font-weight:800;background:#0d0f12}
    .mean {font-size:26px;font-weight:700;background:#0d0f12}
    .usage{font-size:20px;font-family:Consolas,ui-monospace,monospace;background:#0d0f12}

    .ctrl{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .pill{background:#243352;border:1px solid #2d4371;border-radius:999px;padding:6px 10px}
    .ghost{background:transparent;border-color:#334;opacity:.85}

    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.65);
      display:none; place-items:center; z-index:99
    }
    .modal{
      width:min(90vw,520px);background:#111826;border:1px solid #2a3246;border-radius:16px;
      padding:22px;text-align:center
    }
    .bubble{
      margin:14px auto 8px;width:220px;height:220px;border-radius:50%;
      background:#2a2f3f;display:grid;place-items:center; font-weight:700
    }
    .dim{opacity:.55}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Flash Learning â€” PWA + TTS</h1>

  <div class="row">
    <span class="pill">ë„ë©”ì¸</span>
    <select id="domain">
      <option value="python">python</option>
      <option value="mysql">mysql</option>
      <option value="pandas">pandas</option>
      <option value="english">english</option>
    </select>

    <span class="pill" id="lv-label">ë ˆë²¨</span>
    <select id="level">
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
    </select>

    <span class="pill" id="cat-label" style="display:none">ì¹´í…Œê³ ë¦¬</span>
    <select id="category" style="display:none">
      <option value="vocab">vocab</option>
      <option value="coding">coding</option>
      <option value="pattern">pattern</option>
      <option value="conversation">conversation</option>
    </select>

    <span class="pill">ì¥ìˆ˜</span>
    <select id="count">
      <option>30</option><option>25</option><option>20</option><option>15</option><option>10</option>
    </select>

    <button id="start" class="pill" style="background:#2e64ff;border-color:#2e64ff;color:#fff">3íšŒ ë£¨í”„ ì‹œì‘</button>
  </div>

  <div class="hint">í•™ìŠµ ë°©ë²• ì•ˆë‚´<br>ì´ í”Œë˜ì‹œ í›ˆë ¨ì€ ì™¸ì›Œì•¼ í•œë‹¤ëŠ” ì••ë°•ì´ ì•„ë‹Œ<br>ë°˜ë³µ ë…¸ì¶œ í›ˆë ¨ì…ë‹ˆë‹¤.<br>ë…¸ì¶œ ì‹œê°„ì€ ì§§ê³ (1~1.5ì´ˆ), 3íšŒ ë£¨í”„ë¡œ ì§„í–‰í•˜ë©°<br>íšŒì°¨ ì‚¬ì´ 2ë¶„ ì¥ê¸° ê¸°ì–µì¥ì¹˜ì— ì €ì¥í•˜ê¸° ìœ„í•œ<br>ëª…ìƒ íœ´ì‹ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.</div>

  <div class="row">
    <div class="bar" style="flex:1"><i id="prog"></i></div>
    <div id="state" class="pill ghost">0/0</div>
  </div>

  <div class="ctrl">
    <span class="pill ghost">ìë™(ì´ˆ)</span>
    <input id="autoSec" type="range" min="0.5" max="5" step="0.1" value="1.2" style="width:180px" />
    <span id="autoSecLabel">1.2s</span>

    <button id="prev" class="pill ghost">â—€ ì´ì „</button>
    <button id="next" class="pill ghost">ë‹¤ìŒ â–¶</button>
    <button id="auto" class="pill">â–¶ ìë™</button>

    <button id="sayEN" class="pill ghost">ğŸ”ˆ EN</button>
    <button id="sayKO" class="pill ghost">ğŸ”ˆ KO</button>
    <label class="pill ghost"><input id="autoRead" type="checkbox" checked /> ìë™ì½ê¸°</label>

    <div class="sp"></div>
    <button id="quit" class="pill ghost">ì¢…ë£Œ</button>
  </div>

  <div class="grid">
    <div id="kw" class="card kw"></div>
    <div id="mean" class="card mean"></div>
    <div id="usage" class="card usage"></div>
  </div>
</div>

<!-- ëª…ìƒ ì˜¤ë²„ë ˆì´ -->
<div id="rest" class="overlay">
  <div class="modal">
    <div class="dim">ëª…ìƒ íœ´ì‹</div>
    <div style="margin:6px 0 12px" class="dim">ë“¤ì´ë§ˆì‹œê¸° 4ì´ˆ â†’ ë©ˆì¶¤ 4ì´ˆ â†’ ë‚´ì‰¬ê¸° 6ì´ˆ</div>
    <div class="bubble" id="bubble">2:00</div>
    <div id="phase" class="dim">ë“¤ì´ë§ˆì‹œê¸°</div>
    <div style="margin-top:12px"><button id="skip" class="pill">ê±´ë„ˆë›°ê¸°</button></div>
  </div>
</div>

<script>
/* ---------- PWA ë“±ë¡ ---------- */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}

/* ---------- ìƒíƒœ ---------- */
const $ = (s)=>document.querySelector(s);
const el = {
  domain:  $('#domain'),
  level:   $('#level'),
  catLab:  $('#cat-label'),
  cat:     $('#category'),
  lvLab:   $('#lv-label'),
  start:   $('#start'),
  count:   $('#count'),
  prog:    $('#prog'),
  state:   $('#state'),
  autoSec: $('#autoSec'),
  autoSecLabel: $('#autoSecLabel'),
  prev:    $('#prev'),
  next:    $('#next'),
  auto:    $('#auto'),
  sayEN:   $('#sayEN'),
  sayKO:   $('#sayKO'),
  autoRead:$('#autoRead'),
  kw:      $('#kw'),
  mean:    $('#mean'),
  usage:   $('#usage'),
  rest:    $('#rest'),
  bubble:  $('#bubble'),
  phase:   $('#phase'),
  skip:    $('#skip')
};

let ctx = {
  domain:'python',
  level:1,
  category:'vocab',
  page:30,
  auto:false,
  interval:1.2,
  round:0,            // 1..3
  idx:0,
  deck:[],
  seen:new Set(),     // ì„¸ì…˜ ì „ì²´ ì¤‘ë³µ ë°©ì§€
  startTime:0
};

el.domain.addEventListener('change', onDomainChange);
function onDomainChange(){
  ctx.domain = el.domain.value;
  if (ctx.domain==='english') {
    el.level.style.display='none';
    el.lvLab.style.display='none';
    el.cat.style.display='';
    el.catLab.style.display='';
  } else {
    el.level.style.display='';
    el.lvLab.style.display='';
    el.cat.style.display='none';
    el.catLab.style.display='none';
  }
}
onDomainChange();

/* ---------- ìœ í‹¸ ---------- */
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}
function sample(a,k){const x=a.slice();shuffle(x);return x.slice(0,Math.min(k,x.length));}
function centerProgress(cur,total){ const p = total? Math.round(cur/total*100):0; el.prog.style.width = p+'%'; }
function setStateText(){ const total=ctx.deck.length; const head = ctx.domain==='english' ? `${ctx.domain}` : `${ctx.domain} L${ctx.level}`; el.state.textContent = `${ctx.idx+1}/${total} Â· ${head} Â· ${ctx.round}/3`; }

/* ë£¨íŠ¸/ data/ë¥¼ ëª¨ë‘ ì‹œë„ + ì—ëŸ¬ ë©”ì‹œì§€ ë…¸ì¶œ + ë¦¬í¬ ê²½ë¡œ ë³´ì • */
async function fetchJsonSmart(name){
  const base = location.pathname.endsWith('/')
    ? location.pathname
    : location.pathname.replace(/\/[^/]*$/, '/'); // /flash-learning/

  const paths = [
    new URL('data/' + name, location.origin + base).toString(),
    new URL(name,          location.origin + base).toString(),
  ];

  let lastErr = '';
  for (const url of paths){
    try{
      const r = await fetch(url, {cache:'no-cache'});
      if (r.ok) return await r.json();
      lastErr = `[${r.status}] ${url}`;
    }catch(e){
      lastErr = `${url} :: ${e}`;
    }
  }
  // í™”ë©´ì— ì¦‰ì‹œ í‘œì‹œ(ë¬´ì—‡ì„ ëª» ì½ëŠ”ì§€)
  alert('ë°ì´í„° íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:\n' + name + '\n' + lastErr);
  throw new Error('JSON load failed: ' + name + ' :: ' + lastErr);
}

/* ë„ë©”ì¸ë³„ ë°ì´í„° ë¡œë“œ */
async function loadDeck(){
  if (ctx.domain==='english'){
    const map = {
      vocab:'english_vocab.json',
      coding:'english_coding.json',
      pattern:'english_pattern.json',
      conversation:'english_conversation.json'
    };
    return await fetchJsonSmart(map[ctx.category]);
  }else{
    const rows = await fetchJsonSmart(`${ctx.domain}_L${ctx.level}.json`);
    return rows;
  }
}

/* r3 í˜¼í•© (íƒœê·¸ ìš°ì„ , ì¤‘ë³µ íšŒí”¼) */
function pickRound3(rows, seen, k){
  const pool = rows.filter(c=>!seen.has(c.keyword));
  shuffle(pool);
  const core = pool.filter(c=>Array.isArray(c.tags) && c.tags.includes('core'));
  const applied = pool.filter(c=>Array.isArray(c.tags) && c.tags.includes('applied'));
  const other = pool.filter(c=>!Array.isArray(c.tags) || (!c.tags.includes('core') && !c.tags.includes('applied')));
  const out=[];
  function take(list,n){for(const c of list){if(out.length>=k)break; if(!out.find(x=>x.keyword===c.keyword)) out.push(c);}}
  take(core,Math.min(10,k));
  take(applied,Math.min(20,k-out.length));
  take(other,k-out.length);
  // ë¶€ì¡± ì‹œ ì•„ë¬´ê±°ë‚˜
  if(out.length<k){
    const fill = rows.filter(c=>!out.find(x=>x.keyword===c.keyword));
    shuffle(fill); out.push(...fill.slice(0,k-out.length));
  }
  return out.slice(0,k);
}

/* ---------- TTS (ê²¹ì¹¨ ë°©ì§€) ---------- */
const synth = window.speechSynthesis;
function speak(text, lang){
  if(!text) return;
  try{ synth.cancel(); }catch{}
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang || 'en-US';
  u.rate = 1.0; u.pitch = 1.0; u.volume = 1.0;
  synth.speak(u);
}
function speakForCard(card){
  // ì˜ì–´: usage_one_liner(ìˆìœ¼ë©´) â†’ ì˜ë¯¸(ko)
  if(ctx.domain==='english'){
    const en = card.usage_one_liner || card.keyword || '';
    speak(en,'en-US');
    setTimeout(()=>{ speak(card.meaning||'', 'ko-KR'); }, 380);
    return;
  }
  // ì½”ë”©/DB/íŒë‹¤ìŠ¤: í‚¤ì›Œë“œë§Œ
  speak(card.keyword||'', 'en-US');
}

/* ---------- ì¹´ë“œ ë Œë” ---------- */
function render(){
  const c = ctx.deck[ctx.idx] || {};
  el.kw.textContent    = c.keyword || '';
  el.mean.textContent  = c.meaning || '';
  if (ctx.domain==='english' && Array.isArray(c.items) && c.items.length){
    const lines = c.items.slice(0,12).map(it=>`â€¢ ${it.en||''} / ${it.ko||''}`);
    el.usage.textContent = lines.join('\n');
  } else {
    el.usage.textContent = c.usage_one_liner || '';
  }
  centerProgress(ctx.idx+1, ctx.deck.length);
  setStateText();
  if (el.autoRead.checked) speakForCard(c);
}

/* ---------- ë¼ìš´ë“œ/ëª…ìƒ ---------- */
function showRest(sec=120){
  return new Promise(resolve=>{
    el.rest.style.display='grid';
    let left = sec; let phase = 'ë“¤ì´ë§ˆì‹œê¸°'; let t0 = Date.now();
    const tick = ()=>{
      // ì´ˆ ì¹´ìš´íŠ¸
      const d = Date.now()-t0;
      if(d>=1000){ t0 = Date.now(); left--; }
      // í˜¸í¡ ì• ë‹ˆ
      const mod = (Date.now()/1000)%14; // 4,4,6
      if(mod<4) phase='ë“¤ì´ë§ˆì‹œê¸°'; else if(mod<8) phase='ë©ˆì¶¤'; else phase='ë‚´ì‰¬ê¸°';
      el.phase.textContent = phase;
      const m = Math.floor(Math.max(0,left)/60), s = Math.max(0,left)%60;
      el.bubble.textContent = `${m}:${(s+'').padStart(2,'0')}`;
      if(left<=0) return resolve();
      raf = requestAnimationFrame(tick);
    };
    let raf = requestAnimationFrame(tick);
    el.skip.onclick = ()=>resolve();
  }).finally(()=>{ el.rest.style.display='none'; });
}

async function startRound(r){
  ctx.round = r;
  ctx.idx = 0;

  // ë± êµ¬ì„±
  const rows = await loadDeck();
  const k = +el.count.value;
  if (ctx.domain==='english'){
    // ì˜ì–´ëŠ” ë§¤ ë¼ìš´ë“œ ëœë¤ + ì„¸ì…˜ ì¤‘ë³µ ìµœì†Œí™”
    const unseen = rows.filter(c=>!ctx.seen.has(c.keyword));
    let chosen = sample(unseen, k);
    if (chosen.length<k){ // ë¶€ì¡±í•˜ë©´ ë‚˜ë¨¸ì§€ì—ì„œ ë³´ì¶©
      const rest = rows.filter(c=>!chosen.find(x=>x.keyword===c.keyword));
      chosen = chosen.concat(sample(rest, k-chosen.length));
    }
    ctx.deck = chosen.slice(0,k);
  }else{
    if (r===1){
      // r1: ìˆœì°¨(ê°€ëŠ¥í•˜ë©´ order_index ì •ë ¬)
      const ordered = rows.slice().sort((a,b)=>(a.order_index??1e9)-(b.order_index??1e9));
      ctx.deck = ordered.slice(0,k);
    }else if (r===2){
      // r2: ëœë¤
      ctx.deck = sample(rows,k);
    }else{
      // r3: í˜¼í•©
      ctx.deck = pickRound3(rows, ctx.seen, k);
    }
  }
  if (ctx.deck.length===0){
    alert('ì„ íƒí•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    return false;
  }
  render();
  return true;
}

async function runSession(){
  ctx.seen.clear();
  ctx.startTime = Date.now();
  // r1
  if(!(await startRound(1))) return;
  ctx.auto = true; loopAuto();
}

async function afterRoundAdvance(){
  if (ctx.round===1 || ctx.round===2){
    await showRest(120);
    await startRound(ctx.round+1);
  } else {
    ctx.auto = false;
    alert('3íšŒ ë£¨í”„ ì™„ë£Œ!');
  }
}

/* ---------- ìë™ ë£¨í”„ ---------- */
let autoTimer = 0;
function loopAuto(){
  clearTimeout(autoTimer);
  if(!ctx.auto) return;
  autoTimer = setTimeout(()=>{
    if (ctx.idx < ctx.deck.length-1){
      const cur = ctx.deck[ctx.idx];
      if(cur?.keyword) ctx.seen.add(cur.keyword);
      ctx.idx++; render();
      loopAuto();
    }else{
      // ë¼ìš´ë“œ ì¢…ë£Œ
      const cur = ctx.deck[ctx.idx];
      if(cur?.keyword) ctx.seen.add(cur.keyword);
      afterRoundAdvance().then(()=>{ if(ctx.auto) loopAuto(); });
    }
  }, Math.max(200, (ctx.interval*1000)|0));
}

/* ---------- ì´ë²¤íŠ¸ ---------- */
el.autoSec.addEventListener('input', ()=>{
  ctx.interval = +el.autoSec.value;
  el.autoSecLabel.textContent = ctx.interval.toFixed(1)+'s';
});

el.start.addEventListener('click', async ()=>{
  ctx.domain   = el.domain.value;
  ctx.level    = +el.level.value;
  ctx.category = el.category.value;
  ctx.page     = +el.count.value;
  ctx.auto     = false;
  await runSession();
});

el.prev.addEventListener('click', ()=>{
  ctx.idx = Math.max(0, ctx.idx-1); render();
});
el.next.addEventListener('click', ()=>{
  if (ctx.idx < ctx.deck.length-1){
    const cur = ctx.deck[ctx.idx];
    if(cur?.keyword) ctx.seen.add(cur.keyword);
    ctx.idx++; render();
  }else{
    const cur = ctx.deck[ctx.idx];
    if(cur?.keyword) ctx.seen.add(cur.keyword);
    afterRoundAdvance();
  }
});
el.auto.addEventListener('click', ()=>{
  ctx.auto = !ctx.auto;
  el.auto.textContent = ctx.auto ? 'â¸ ì¼ì‹œì •ì§€' : 'â–¶ ìë™';
  if (ctx.auto) loopAuto();
});
el.sayEN.addEventListener('click', ()=>{
  const c = ctx.deck[ctx.idx]||{};
  if (ctx.domain==='english') speak(c.usage_one_liner||c.keyword||'','en-US');
  else speak(c.keyword||'','en-US');
});
el.sayKO.addEventListener('click', ()=>{
  const c = ctx.deck[ctx.idx]||{};
  speak(c.meaning||'','ko-KR');
});
el.quit.addEventListener('click', ()=>{ location.reload(); });
</script>
</body>
</html>
