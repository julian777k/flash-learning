<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Flash Learning — PWA + TTS</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f0f12">
  <link rel="icon" href="icon-192.png">
  <style>
    :root {
      --bg:#0f1116; --panel:#161a22; --muted:#9aa4b2; --text:#e7ecf3; --accent:#5aa0ff;
      --card:#0d0f14; --line:#2a3242;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Malgun Gothic,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .wrap{max-width:1100px;margin:24px auto 80px;padding:0 16px}
    h1{margin:0 0 12px;font-size:24px}
    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0 10px}
    select,button,input[type="number"],input[type="range"]{background:var(--panel);color:var(--text);border:1px solid var(--line);padding:8px 10px;border-radius:10px;outline:none}
    button{cursor:pointer}
    .hint{color:var(--muted);font-size:13px;margin:10px 0 16px}
    .topbar{display:flex;align-items:center;gap:14px}
    .pill{background:#1a2230;padding:8px 12px;border-radius:999px;border:1px solid var(--line)}
    .progress{display:flex;align-items:center;gap:8px;margin:10px 0 12px}
    .bar{height:8px;background:#202737;border-radius:999px;flex:1;overflow:hidden}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#5aa0ff,#69e3ff)}
    .cards{display:flex;flex-direction:column;gap:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;min-height:88px;display:flex;align-items:center;justify-content:center;padding:18px;text-align:center;white-space:pre-wrap;word-break:break-word;font-weight:600;letter-spacing:.2px}
    .card.key{min-height:120px;font-size:42px}
    .card.mean{min-height:76px;font-size:24px}
    .card.usage{min-height:120px;font-size:18px;font-family:Consolas,ui-monospace,SFMono-Regular,Menlo,monospace}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .row .sp{flex:1}
    .muted{color:var(--muted)}
    .rest{position:fixed;inset:0;background:rgba(0,0,0,.75);display:none;align-items:center;justify-content:center;z-index:40}
    .rest .panel{width:min(520px,calc(100% - 32px));background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:22px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .breath{width:220px;height:220px;margin:16px auto;border-radius:50%;background:#1f2635;display:grid;place-items:center;overflow:hidden}
    .bubble{width:120px;height:120px;border-radius:50%;background:#88d5ff55}
    .timer{margin-top:6px;font:600 20px/1.2 system-ui,sans-serif}
    .rest .sub{color:var(--muted);font-size:14px}
    @media (max-width:640px){.card.key{font-size:34px}.card.mean{font-size:20px}.card.usage{font-size:16px}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <h1>Flash Learning — PWA + TTS</h1>
      <span class="pill muted" id="stateText">–</span>
    </div>

    <div class="controls">
      <label>도메인
        <select id="domain">
          <option value="python">python</option>
          <option value="mysql">mysql</option>
          <option value="pandas">pandas</option>
          <option value="english">english</option>
        </select>
      </label>

      <label id="lvWrap">레벨
        <select id="level">
          <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
        </select>
      </label>

      <label id="catWrap" style="display:none">카테고리
        <select id="cat">
          <option value="vocab">vocab</option>
          <option value="coding">coding</option>
          <option value="pattern">pattern</option>
          <option value="conversation">conversation</option>
        </select>
      </label>

      <label>장수
        <select id="page">
          <option>20</option><option selected>30</option><option>40</option><option>50</option>
        </select>
      </label>

      <button id="start3" style="background:#143b74;border-color:#204a8f">3회 루프 시작</button>
    </div>

    <div class="hint">영어는 라운드마다 랜덤, 세션 전체에서 중복 최소화 · 라운드 사이 2분 명상</div>

    <div class="progress">
      <div class="bar"><i id="bar"></i></div>
      <span class="muted" id="progText">0/0</span>
    </div>

    <div class="controls">
      <span class="muted">자동(초)</span>
      <input id="autoSec" type="range" min="0.5" max="5" step="0.1" value="1.2" style="width:240px">
      <span class="muted" id="autoSecVal">1.2s</span>

      <button id="prev">◀ 이전</button>
      <button id="next">다음 ▶</button>
      <button id="autoBtn">▶ 자동</button>
      <button id="sayEN">🔊 EN</button>
      <button id="sayKO">🔊 KO</button>
      <label class="muted" style="display:flex;align-items:center;gap:6px">
        <input id="autoRead" type="checkbox" checked> 자동읽기(EN 키워드)
      </label>
      <button id="finish">종료</button>
      <span class="sp"></span>
    </div>

    <div class="cards">
      <div class="card key"   id="keyBox">–</div>
      <div class="card mean"  id="meanBox">–</div>
      <div class="card usage" id="usageBox">–</div>
    </div>
  </div>

  <!-- REST overlay -->
  <div class="rest" id="rest">
    <div class="panel">
      <h3 style="margin:0 0 6px">명상 휴식</h3>
      <div class="sub">들이마시기 4초 → 멈춤 4초 → 내쉬기 6초</div>
      <div class="breath"><div class="bubble" id="bubble"></div></div>
      <div class="timer" id="restLeft">–</div>
      <div class="sub" id="phase" style="margin-top:6px">–</div>
      <div style="margin-top:12px"><button id="skipRest">건너뛰기</button></div>
    </div>
  </div>

  <script>
  (function(run){
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run);
    else run();
  })(function(){

    /* ------------------------------ utils ------------------------------ */
    const $ = id => document.getElementById(id);
    const sleep = ms => new Promise(r=>setTimeout(r, ms));

    // 같은 폴더 우선, 없으면 /data/ 폴더에서 재시도
    function dataURL(domain, level, cat){
      const file = (domain==='english') ? `english_${cat||'vocab'}.json` : `${domain}_L${level}.json`;
      return [new URL(file, location.href).href, new URL('data/'+file, location.href).href];
    }
    async function fetchJSONSmart(a,b){
      for (const u of [a,b]) {
        try{ const r = await fetch(u,{cache:'no-cache'}); if (r.ok) return await r.json(); }catch(_){}
      }
      return null;
    }

    function seedRandom(seed){ let s=(seed??Date.now())>>>0; return ()=>{ s=(s*1664525+1013904223)>>>0; return (s>>>8)/0x01000000; }; }
    function shuffle(arr, rng){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){ const j=(rng?Math.floor(rng()*(i+1)):Math.floor(Math.random()*(i+1))); [a[i],a[j]]=[a[j],a[i]]; } return a; }

    // 항상 k장을 보장 (데이터가 부족하면 순환 보충)
    function ensureKRandom(rows, k, seed){
      const rng = seedRandom(seed);
      const uniq = []; const seen=new Set();
      for (const r of rows){ const key = r.keyword||r.id||JSON.stringify(r).slice(0,50); if(!seen.has(key)){ uniq.push(r); seen.add(key); } }
      if (uniq.length >= k) return shuffle(uniq, rng).slice(0,k);
      if (!uniq.length) return [];
      let pool = uniq.slice();
      while (pool.length < k) pool = pool.concat(uniq);
      return shuffle(pool, rng).slice(0,k);
    }

    /* ------------------------------ state ------------------------------ */
    const st = {
      domain: $('domain').value,
      level:  Number($('level').value),
      cat:    $('cat').value,
      page:   Number($('page').value),
      round:  0,
      deck:   [],
      idx:    0,
      prev:   new Set(),
      auto:   false,
      autoSec: Number($('autoSec').value),
      autoRead: $('autoRead').checked, // EN만 자동
      restSec: 120,
      startTime: 0
    };
    function setDomainUI(){
      const isEn = st.domain==='english';
      $('lvWrap').style.display  = isEn ? 'none' : '';
      $('catWrap').style.display = isEn ? '' : 'none';
    }
    setDomainUI();

    /* ------------------------------ WebAudio beep ------------------------------ */
    let audioCtx=null;
    function ensureAudio(){
      if(!audioCtx){ const C=window.AudioContext||window.webkitAudioContext; if(C) audioCtx=new C(); }
      if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
    }
    window.addEventListener('pointerdown', ()=>{ ensureAudio(); }, {once:true});
    function beep(freq=880, ms=140, vol=0.12){
      try{ ensureAudio(); if(!audioCtx) return;
        const osc=audioCtx.createOscillator(), g=audioCtx.createGain();
        g.gain.value=vol; osc.type='sine'; osc.frequency.value=freq;
        osc.connect(g).connect(audioCtx.destination); osc.start();
        setTimeout(()=>{ osc.stop(); osc.disconnect(); g.disconnect(); }, ms|0);
      }catch(_){}
    }

    /* ------------------------------ TTS (EN only auto) ------------------------------ */
    let voices=[]; const loadVoices=()=>voices=speechSynthesis.getVoices(); loadVoices(); speechSynthesis.onvoiceschanged=loadVoices;
    let ttsToken=0;
    function pickVoice(lang){
      const lc=(lang||'').toLowerCase();
      for(const v of voices){ const id=(v.name+' '+v.lang).toLowerCase(); if(id.includes(lc)) return v; }
      return null;
    }
    function speakOnce(text, lang){
      return new Promise(resolve=>{
        if(!text){ resolve(); return; }
        try{
          speechSynthesis.cancel();
          const u=new SpeechSynthesisUtterance(text);
          const vv=pickVoice(lang);
          if(vv){ u.voice=vv; u.lang=vv.lang; } else u.lang=(lang==='en'?'en-US':'ko-KR');
          u.rate=1.0; u.pitch=1.0;
          u.onend=u.onerror=()=>resolve();
          speechSynthesis.speak(u);
        }catch(_){ resolve(); }
      });
    }
    // 자동 읽기는 EN 키워드만
    async function speakAutoEN(){
      if(!st.autoRead) return;
      const token=++ttsToken;
      const c=cur(); if(!c) return;
      await speakOnce(getENKeyword(c),'en');
      if(token!==ttsToken) return;
    }

    /* ------------------------------ deck build ------------------------------ */
    function cur(){ return st.deck[st.idx]; }
    function updateState(){
      const t=`${st.domain} · ${st.domain==='english'?st.cat:('L'+st.level)} · ${st.round}/3 · ${Math.min(st.idx+1,st.deck.length)}/${Math.max(1,st.deck.length||1)}`;
      $('stateText').textContent=t;
      const cur=Math.min(st.idx+1, st.deck.length||0), tot=st.deck.length||0;
      $('progText').textContent=`${cur}/${tot}`;
      $('bar').style.width=(tot? (cur/tot*100):0)+'%';
    }
    function getENKeyword(c){ return (c && c.keyword) ? String(c.keyword) : ''; }
    function getKOText(c){
      if(!c) return '';
      if(st.domain==='english'){
        if(c.category==='pattern' && Array.isArray(c.items)) return c.items.slice(0,3).map(x=>x.ko).filter(Boolean).join(' / ');
        return c.meaning || '';
      }
      return c.meaning || '';
    }
    function renderCard(){
      const c=cur();
      if(!c){
        $('keyBox').textContent='카드가 없습니다'; $('meanBox').textContent=''; $('usageBox').textContent='';
        updateState(); return;
      }
      $('keyBox').textContent = c.keyword || '';
      $('meanBox').textContent = c.meaning || '';
      let usage='';
      if(st.domain==='english'){
        if(c.category==='pattern' && Array.isArray(c.items)) usage = c.items.map(it=>`• ${it.en}  /  ${it.ko}`).join('\n');
        else usage = c.usage_one_liner || '';
      }else usage = c.usage_one_liner || '';
      $('usageBox').textContent = usage;
      updateState();
      speakAutoEN(); // EN 키워드만 자동 읽기
    }

    function pickEnglish(rows, k){
      const rng = seedRandom(Date.now());
      // 세션 전체에서 중복 최소화 후, 부족하면 순환 보충
      const unseen = rows.filter(r=>!st.prev.has(r.keyword));
      let chosen = shuffle(unseen, rng).slice(0,k);
      chosen.forEach(c=> st.prev.add(c.keyword));
      if (chosen.length < k){
        // 나머지는 전체에서 보충
        const rest = rows.filter(r=>!chosen.some(x=>x.keyword===r.keyword));
        chosen = chosen.concat(shuffle(rest, rng).slice(0, k-chosen.length));
      }
      if (chosen.length < k){
        // 그래도 부족하면 순환
        chosen = ensureKRandom(chosen.length?chosen:rows, k, Date.now());
      }
      return chosen.slice(0,k);
    }

    async function loadRows(){
      const [u1,u2] = dataURL(st.domain, st.level, st.cat);
      const rows = await fetchJSONSmart(u1, u2);
      if(!rows || !rows.length) throw new Error('데이터 로드 실패');
      return rows;
    }

    async function buildR1(rows){
      // ✅ R1도 항상 섞어서 k장 보장
      return ensureKRandom(rows, st.page, Date.now());
    }
    function buildR2(rows){ return ensureKRandom(rows, st.page, Date.now()); }
    function buildR3(rows){
      // core/applied 우대 + 부족 시 보충
      const core    = rows.filter(c=>(c.tags||[]).includes('core'));
      const applied = rows.filter(c=>(c.tags||[]).includes('applied'));
      const other   = rows.filter(c=>!(c.tags||[]).some(t=>t==='core'||t==='applied'));
      let out=[]; const rng=seedRandom(Date.now());
      out = out.concat(shuffle(core, rng).slice(0, Math.min(10, st.page)));
      if(out.length<st.page) out = out.concat(shuffle(applied, rng).slice(0, Math.min(20, st.page-out.length)));
      if(out.length<st.page) out = out.concat(shuffle(other, rng).slice(0, st.page-out.length));
      if(out.length<st.page) out = ensureKRandom(out.length?out:rows, st.page, Date.now());
      return out.slice(0,st.page);
    }

    /* ------------------------------ rest flow ------------------------------ */
    function showRest(sec){
      $('rest').style.display='flex';
      let left=sec; $('restLeft').textContent=`${left}초`;
      let t0=performance.now(); let last='';
      function bubbleScale(r){ $('bubble').style.transform=`scale(${0.55+0.45*Math.max(0,Math.min(1,r))})`; }
      function frame(now){
        const t=(now-t0)/1000, cycle=14, x=t%cycle;
        let phase, ratio;
        if(x<4){ phase='들이마시기'; ratio=x/4; }
        else if(x<8){ phase='멈춤'; ratio=1; }
        else { phase='내쉬기'; ratio=1-(x-8)/6; }
        $('phase').textContent=phase; bubbleScale(ratio);
        if(phase!==last){ last=phase; if(phase==='들이마시기')beep(880,140); else if(phase==='멈춤')beep(660,120); else beep(440,120); }
        req=requestAnimationFrame(frame);
      }
      let req=requestAnimationFrame(frame);
      let tick=setInterval(()=>{ left--; $('restLeft').textContent=`${left}초`; if(left<=0){clearInterval(tick); cancelAnimationFrame(req); finish();}},1000);
      $('skipRest').onclick=()=>{clearInterval(tick); cancelAnimationFrame(req); finish();};
      function finish(){ beep(660,120); setTimeout(()=>beep(880,120),150); setTimeout(()=>beep(550,180),330); hideRest(); nextRound(); }
    }
    function hideRest(){ $('rest').style.display='none'; }

    async function startSession(){
      st.prev.clear(); st.round=1; st.idx=0; st.startTime=Date.now();
      const rows=await loadRows();
      st.deck = (st.domain==='english') ? pickEnglish(rows, st.page) : await buildR1(rows);
      renderCard(); st.auto=true;
    }
    async function nextRound(){
      st.round++;
      if(st.round>3){ st.auto=false; alert('3회 루프 완료!'); return; }
      const rows=await loadRows();
      if(st.domain==='english'){
        st.deck = pickEnglish(rows, st.page);
      }else if(st.round===2){
        st.deck = buildR2(rows);
      }else{
        st.deck = buildR3(rows);
      }
      st.idx=0; renderCard(); st.auto=true;
    }

    /* ------------------------------ events ------------------------------ */
    $('domain').addEventListener('change', e=>{ st.domain=e.target.value; setDomainUI(); });
    $('level').addEventListener('change', e=> st.level=Number(e.target.value));
    $('cat').addEventListener('change', e=> st.cat=e.target.value);
    $('page').addEventListener('change', e=> st.page=Number(e.target.value));
    $('autoSec').addEventListener('input', e=>{ st.autoSec=Number(e.target.value); $('autoSecVal').textContent=st.autoSec.toFixed(1)+'s'; });
    $('autoRead').addEventListener('change', e=> st.autoRead=e.target.checked);

    $('start3').addEventListener('click', async ()=>{
      try{
        st.domain=$('domain').value; st.level=Number($('level').value); st.cat=$('cat').value; st.page=Number($('page').value);
        await startSession();
      }catch(err){ console.error(err); alert('데이터를 불러오지 못했습니다.'); }
    });

    $('prev').addEventListener('click', ()=>{ if(st.idx>0){ st.idx--; renderCard(); } });
    $('next').addEventListener('click', ()=>{ if(!st.deck.length) return;
      if(st.idx<st.deck.length-1){ st.prev.add((cur().keyword)||''); st.idx++; renderCard(); }
      else{ st.prev.add((cur().keyword)||''); if(st.round>=1) showRest(st.restSec); }
    });
    $('autoBtn').addEventListener('click', ()=>{ st.auto=!st.auto; $('autoBtn').textContent=st.auto?'⏸ 일시정지':'▶ 자동'; });

    // 수동 읽기: 큐 끊고 해당 언어 1회
    $('sayEN').addEventListener('click', ()=>{ ttsToken++; speakOnce(getENKeyword(cur()),'en'); });
    $('sayKO').addEventListener('click', ()=>{ ttsToken++; speakOnce(getKOText(cur()),'ko'); });

    $('finish').addEventListener('click', ()=>{ st.auto=false; alert('세션 종료'); });

    // 자동 넘김 루프
    (function autoLoop(){
      let last=performance.now();
      function tick(now){
        const dt=now-last;
        if(st.auto && st.deck.length){
          if(dt>=st.autoSec*1000){
            last=now;
            if(st.idx<st.deck.length-1){ st.prev.add((cur().keyword)||''); st.idx++; renderCard(); }
            else{ st.prev.add((cur().keyword)||''); st.auto=false; showRest(st.restSec); }
          }
        }else last=now;
        requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    })();

    updateState();

    // SW
    if('serviceWorker' in navigator){
      window.addEventListener('load', ()=>navigator.serviceWorker.register('sw.js').catch(console.warn));
    }
  });
  </script>
</body>
</html>
