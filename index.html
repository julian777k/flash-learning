<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Flash Learning â€” PWA + TTS</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0f0f12" />
  <link rel="icon" href="icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --bg:#0f1116; --card:#101216; --line:#262a33; --fg:#e6e8ee; --mut:#99a1b3;
      --accent:#4ea1ff; --accent-2:#2ecc71; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:1000px; margin:28px auto; padding:0 16px}
    h1{margin:0 0 12px; font-weight:800}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:8px 0}
    select,button,input[type="number"]{
      background:#171a21; color:var(--fg); border:1px solid var(--line); border-radius:10px; padding:9px 12px; font-size:15px;
    }
    button{cursor:pointer}
    .btn-primary{background:#1d5cff; border-color:#1d5cff; color:#fff}
    .btn-ghost{background:#171a21}
    .mut{color:var(--mut)}

    /* progress */
    .progbar{height:8px; width:100%; background:#171a21; border:1px solid var(--line); border-radius:999px; overflow:hidden}
    .progbar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,#3c8cff,#73d0ff)}

    /* === ì¹´ë“œ íŒ¨ë„: ê°€ìš´ë° ì •ë ¬(ê°€ë¡œ/ì„¸ë¡œ) ê³ ì • === */
    .panel{
      background:var(--card); border:1px solid var(--line); border-radius:14px;
      padding:18px; min-height:76px;
      display:flex; align-items:center; justify-content:center;   /* ì„¼í„° */
      margin-top:12px;
    }
    .panel .txt{
      width:100%;
      text-align:center;
      white-space:pre-wrap;           /* ê°œí–‰ ìœ ì§€ + ìë™ ì¤„ë°”ê¿ˆ */
      word-break:break-word;          /* ê¸´ í† í° ì¤„ë°”ê¿ˆ */
    }
    .panel.kw .txt{
      font-weight:800;
      font-size:clamp(24px,5.8vw,44px);
    }
    .panel.mean .txt{
      font-weight:800;
      font-size:clamp(16px,3.6vw,26px);
    }
    .panel.usage .txt{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;
      font-size:clamp(14px,3.3vw,20px);
    }
    /* <pre>ë¥¼ ì“°ë”ë¼ë„ ì¤‘ì•™ ìœ ì§€(iOS ëŒ€ì‘) */
    .panel.usage pre.txt{display:inline-block; margin:0 auto; white-space:pre-wrap;}

    .right{margin-left:auto}
    .chip{padding:6px 10px; border:1px solid var(--line); border-radius:999px; color:var(--mut)}
    .row2{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .slider{accent-color:#1d5cff}
    .spacer{height:6px}

    @media (max-width:520px){
      .wrap{padding:0 10px}
      select,button{font-size:14px}
    }
  </style>
</head>
<body>
<div class="wrap">

  <h1>Flash Learning â€” PWA + TTS</h1>

  <div class="row">
    <span class="chip">ë„ë©”ì¸</span>
    <select id="domain">
      <option value="python">python</option>
      <option value="mysql">mysql</option>
      <option value="pandas">pandas</option>
      <option value="english">english</option>
    </select>

    <span class="chip" id="lab-level">ë ˆë²¨</span>
    <select id="level">
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
    </select>

    <span class="chip" id="lab-cat" style="display:none">ì¹´í…Œê³ ë¦¬</span>
    <select id="cat" style="display:none">
      <option value="vocab">vocab</option>
      <option value="coding">coding</option>
      <option value="pattern">pattern</option>
      <option value="conversation">conversation</option>
    </select>

    <span class="chip">ì¥ìˆ˜</span>
    <select id="page">
      <option>30</option><option>25</option><option>20</option><option>15</option>
    </select>

    <button class="btn-primary" id="start">3íšŒ ë£¨í”„ ì‹œì‘</button>
  </div>

  <div class="mut">í•™ìŠµ ë°©ë²• ì•ˆë‚´<br>ì´ í”Œë˜ì‹œ í›ˆë ¨ì€ ì™¸ì›Œì•¼ í•œë‹¤ëŠ” ì••ë°•ì´ ì•„ë‹Œ<br>ë°˜ë³µ ë…¸ì¶œ í›ˆë ¨ì…ë‹ˆë‹¤<br>ë…¸ì¶œ ì‹œê°„ì€ ì§§ê³ (1~1.5ì´ˆ), 3íšŒ ë£¨í”„ë¡œ ì§„í–‰í•˜ë©°<br>íšŒì°¨ ì‚¬ì´ 2ë¶„ ì¥ê¸° ê¸°ì–µì¥ì¹˜ì— ì €ì¥í•˜ê¸° ìœ„í•œ<br>ëª…ìƒ íœ´ì‹ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.</div>

  <div class="spacer"></div>
  <div class="row2">
    <div class="progbar" style="flex:1 1 360px"><i id="bar"></i></div>
    <div class="mut" id="state">0/0 (0%)</div>
  </div>

  <div class="row2">
    <span class="chip">ìë™(ì´ˆ)</span>
    <input id="autoSec" class="slider" type="range" min="0.6" max="5" step="0.1" value="1.2" />
    <b id="autoSecV">1.2s</b>
    <button id="prev" class="btn-ghost">â—€ ì´ì „</button>
    <button id="next" class="btn-ghost">ë‹¤ìŒ â–¶</button>
    <button id="autoplay" class="btn-ghost">â–¶ ìë™</button>
    <button id="sayEN" class="btn-ghost">ğŸ”Š EN</button>
    <button id="sayKO" class="btn-ghost">ğŸ”Š KO</button>
    <label style="display:flex;align-items:center;gap:6px">
      <input id="autoTTS" type="checkbox" checked /> ìë™ì½ê¸°
    </label>
    <button id="stop" class="btn-ghost right" style="color:#fff;border-color:var(--danger)">ì¢…ë£Œ</button>
  </div>

  <!-- === ì¹´ë“œ í‘œì‹œ ì˜ì—­ (í‚¤ì›Œë“œ / ì˜ë¯¸ / ì˜ˆì‹œ) === -->
  <div class="panel kw"><div id="kw" class="txt"></div></div>
  <div class="panel mean"><div id="mean" class="txt"></div></div>
  <div class="panel usage"><pre id="usage" class="txt"></pre></div>

</div>

<script>
/* ----------------------------
   ë°ì´í„° ë§¤í•‘
----------------------------- */
const EN_FILES = {
  vocab: "english_vocab.json",
  coding: "english_coding.json",
  pattern: "english_pattern.json",
  conversation: "english_conversation.json",
};
function levelFile(domain, level){
  return `${domain}_L${level}.json`;
}

/* ----------------------------
   ìƒíƒœ
----------------------------- */
const ctx = {
  domain: "python",
  level: 1,
  cat: "vocab",
  page: 30,
  round: 0,           // 1..3
  idx: 0,
  deck: [],
  seen: new Set(),    // ì„¸ì…˜ ì¤‘ë³µ ë°©ì§€
  auto: false,
  autoMs: 1200,
  startTs: 0,
};

const el = (id)=>document.getElementById(id);

/* ----------------------------
   UI ìš”ì†Œ
----------------------------- */
const $domain = el("domain");
const $level  = el("level");
const $labLevel = el("lab-level");
const $cat    = el("cat");
const $labCat = el("lab-cat");
const $page   = el("page");
const $start  = el("start");
const $bar    = el("bar");
const $state  = el("state");
const $kw     = el("kw");
const $mean   = el("mean");
const $usage  = el("usage");
const $prev   = el("prev");
const $next   = el("next");
const $auto   = el("autoplay");
const $autoSec= el("autoSec");
const $autoSecV= el("autoSecV");
const $sayEN  = el("sayEN");
const $sayKO  = el("sayKO");
const $autoTTS= el("autoTTS");
const $stop   = el("stop");

/* ----------------------------
   ë„ë©”ì¸ ì„ íƒ ì‹œ level/cat í† ê¸€
----------------------------- */
function syncDomainUI(){
  const d = $domain.value;
  if(d === "english"){
    $labLevel.style.display = "none";
    $level.style.display    = "none";
    $labCat.style.display   = "";
    $cat.style.display      = "";
  }else{
    $labLevel.style.display = "";
    $level.style.display    = "";
    $labCat.style.display   = "none";
    $cat.style.display      = "none";
  }
}
$domain.addEventListener("change", syncDomainUI);
syncDomainUI();

/* ----------------------------
   ë°ì´í„° ë¡œë“œ
----------------------------- */
async function loadCards(){
  const d = $domain.value;
  if(d === "english"){
    const file = EN_FILES[$cat.value] || EN_FILES.vocab;
    return fetchJSON(`data/${file}`);
  }else{
    const file = levelFile(d, $level.value);
    return fetchJSON(`data/${file}`);
  }
}
async function fetchJSON(url){
  const r = await fetch(url, {cache:"no-store"});
  if(!r.ok) throw new Error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: "+url);
  return r.json();
}

/* ----------------------------
   ë± êµ¬ì„±
   - r1: ìˆœì°¨ (ì•ì—ì„œ pageê°œ)
   - r2: ëœë¤ (ì¤‘ë³µ ì œê±°)
   - r3: í˜¼í•©(ëœë¤) + ì´ì „ ë¼ìš´ë“œì™€ ì¤‘ë³µ ìµœì†Œí™”
----------------------------- */
function sample(arr, k){
  const a = [...arr];
  for(let i=a.length-1;i>0;--i){ const j = Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }
  return a.slice(0, Math.min(k, a.length));
}
function mixRound3(rows, page, seen){
  const pool = rows.filter(x=>!seen.has(x.keyword));
  if(pool.length < page){
    const rest = rows.filter(x=>!pool.includes(x));
    pool.push(...sample(rest, page - pool.length));
  }
  // íƒœê·¸(core/applied) ìš°ì„ 
  const core = pool.filter(c => (c.tags||[]).includes("core"));
  const applied = pool.filter(c => (c.tags||[]).includes("applied"));
  const other = pool.filter(c => !(c.tags||[]).includes("core") && !(c.tags||[]).includes("applied"));
  const out = [];
  function take(list, k){
    for(const c of list){
      if(out.length>=page) break;
      if(!out.find(x=>x.keyword===c.keyword)) out.push(c);
    }
  }
  take(sample(core,10),10); take(sample(applied,10),10);
  for(const c of sample(other, page*2)){ if(out.length>=page) break; if(!out.find(x=>x.keyword===c.keyword)) out.push(c); }
  if(out.length<page){
    for(const c of rows){ if(out.length>=page) break; if(!out.find(x=>x.keyword===c.keyword)) out.push(c); }
  }
  return out.slice(0,page);
}

/* ----------------------------
   í‘œì‹œ + ì§„í–‰ë°”
----------------------------- */
function showCard(){
  const total = ctx.deck.length;
  const cur = Math.min(ctx.idx+1, total);
  const pct = total? Math.floor(cur/total*100) : 0;

  $bar.style.width = pct + "%";
  $state.textContent = `${cur}/${total} (${pct}%) Â· ${ctx.domain}${ctx.domain==="english"?"":(" L"+ctx.level)} Â· ${ctx.round}/3`;

  const c = ctx.deck[ctx.idx] || {};
  $kw.textContent   = c.keyword || "";
  $mean.textContent = c.meaning || "";
  $usage.textContent= c.usage_one_liner || "";

  // ìë™ ì½ê¸°
  if($autoTTS.checked){
    autoSpeak(c);
  }
}

/* ----------------------------
   ìë™ ì§„í–‰
----------------------------- */
let timer = 0;
function setAuto(on){
  ctx.auto = on;
  $auto.textContent = on? "âšâš ì¼ì‹œì •ì§€" : "â–¶ ìë™";
  if(timer){ clearInterval(timer); timer=0; }
  if(on){
    timer = setInterval(()=>{
      if(ctx.idx < ctx.deck.length-1){
        ctx.seen.add(ctx.deck[ctx.idx].keyword);
        ctx.idx++; showCard();
      }else{
        // ë¼ìš´ë“œ ì¢…ë£Œ â†’ íœ´ì‹ â†’ ë‹¤ìŒ ë¼ìš´ë“œ
        nextRound();
      }
    }, ctx.autoMs);
  }
}
$auto.addEventListener("click", ()=>setAuto(!ctx.auto));

/* ----------------------------
   ë¼ìš´ë“œ/íœ´ì‹
----------------------------- */
async function nextRound(){
  speechSynthesis.cancel();
  ctx.round++;
  if(ctx.round===2 || ctx.round===3){
    await restTimer(120); // 2ë¶„ íœ´ì‹
  }
  if(ctx.round>3){
    setAuto(false);
    alert("3íšŒ ë£¨í”„ ì™„ë£Œ!");
    return;
  }
  // ìƒˆ ë± êµ¬ì„±
  const rows = await loadCards();
  const page = parseInt($page.value,10);

  if(ctx.domain==="english"){
    if(ctx.round===1){
      ctx.deck = sample(rows, page);
    }else{
      // ì˜ì–´ëŠ” ë§¤ ë¼ìš´ë“œ ëœë¤ + ì„¸ì…˜ ì¤‘ë³µ ìµœì†Œí™”
      const unseen = rows.filter(r=>!ctx.seen.has(r.keyword));
      const take = sample(unseen, page);
      if(take.length<page){
        // ë‚¨ì€ê²Œ ì ìœ¼ë©´ ë‚˜ë¨¸ì§€ ì•„ë¬´ê±°ë‚˜ ì±„ì›€(ì´ë¯¸ ë½‘ì€ ê²ƒ ì¤‘ë³µ ìµœì†Œí™”)
        const rest = rows.filter(r=>!take.find(t=>t.keyword===r.keyword));
        take.push(...sample(rest, page-take.length));
      }
      ctx.deck = take.slice(0,page);
    }
  }else{
    if(ctx.round===1){
      ctx.deck = rows.slice(0, page);
    }else if(ctx.round===2){
      ctx.deck = sample(rows, page);
    }else{
      ctx.deck = mixRound3(rows, page, ctx.seen);
    }
  }
  ctx.idx=0;
  showCard();
}

function restTimer(s){
  return new Promise(resolve=>{
    const t0 = performance.now();
    const dlg = document.createElement('div');
    dlg.style.cssText = "position:fixed;inset:0;background:#0b0d12cc;backdrop-filter:blur(2px);display:flex;align-items:center;justify-content:center;z-index:99999";
    dlg.innerHTML = `
      <div style="background:#131722;border:1px solid #2a2f3a;border-radius:16px;padding:24px;min-width:260px;text-align:center;color:#e6e8ee">
        <div style="font-size:20px;font-weight:800;margin-bottom:6px">ëª…ìƒ íœ´ì‹</div>
        <div class="mut">ë“¤ì´ë§ˆì‹œê¸° 4ì´ˆ â†’ ë©ˆì¶¤ 4ì´ˆ â†’ ë‚´ì‰¬ê¸° 6ì´ˆ</div>
        <div id="restLeft" style="font:20px/1.2 ui-monospace,Consolas,monospace;margin:14px 0">ë‚¨ì€ ì‹œê°„: ${s}ì´ˆ</div>
        <button id="skip" class="btn-ghost" style="padding:10px 14px;border-radius:10px;border:1px solid #2a2f3a;color:#e6e8ee;background:#171a21">ê±´ë„ˆë›°ê¸°</button>
      </div>`;
    document.body.appendChild(dlg);
    const $left = dlg.querySelector("#restLeft");
    const $skip = dlg.querySelector("#skip");
    let left = s, handle=0;

    function tick(){
      left--;
      $left.textContent = `ë‚¨ì€ ì‹œê°„: ${left}ì´ˆ`;
      if(left<=0){ done(); }
    }
    handle = setInterval(tick, 1000);
    $skip.onclick = done;

    function done(){
      clearInterval(handle);
      dlg.remove();
      resolve();
    }
  });
}

/* ----------------------------
   ì´ë™/ë²„íŠ¼
----------------------------- */
$prev.addEventListener("click", ()=>{
  speechSynthesis.cancel();
  ctx.idx = Math.max(0, ctx.idx-1); showCard();
});
$next.addEventListener("click", ()=>{
  speechSynthesis.cancel();
  if(ctx.idx < ctx.deck.length-1){
    ctx.seen.add(ctx.deck[ctx.idx].keyword);
    ctx.idx++; showCard();
  }else{
    nextRound();
  }
});
$stop.addEventListener("click", ()=>{
  setAuto(false);
  speechSynthesis.cancel();
});

/* ----------------------------
   ì‹œì‘
----------------------------- */
$start.addEventListener("click", async ()=>{
  speechSynthesis.cancel();
  ctx.domain = $domain.value;
  ctx.level  = parseInt($level.value,10);
  ctx.cat    = $cat.value;
  ctx.page   = parseInt($page.value,10);
  ctx.round  = 0; ctx.idx=0; ctx.seen.clear();
  await nextRound();
  // ìë™ ì‹œì‘
  setAuto(true);
});

/* ----------------------------
   ìŠ¬ë¼ì´ë”
----------------------------- */
$autoSec.addEventListener("input", ()=>{
  $autoSecV.textContent = `${$autoSec.value}s`;
  ctx.autoMs = Math.round(parseFloat($autoSec.value)*1000);
  if(ctx.auto) setAuto(true);
});

/* ----------------------------
   TTS (ê²¹ì¹¨ ë°©ì§€: í•­ìƒ cancelâ†’speak)
----------------------------- */
function speak(text, lang){
  if(!text) return;
  try{
    speechSynthesis.cancel(); // ê²¹ì¹¨ ë°©ì§€
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang || 'en-US';
    u.rate = 1.05;   // ìì—° ì†ë„
    speechSynthesis.speak(u);
  }catch(e){}
}
function textEN(card){
  // ì˜ì–´ ì„¸ì…˜: ë¬¸ì¥/ë‹¨ì–´(usage ìš°ì„ ), ê·¸ ì™¸: í‚¤ì›Œë“œì—ì„œ í•œê¸€ ì œê±° ì‹œë„ í›„ ë‚­ë…
  if(ctx.domain === "english"){
    return (card.usage_one_liner||card.keyword||"").trim();
  }else{
    const k = (card.keyword||"").trim();
    const onlyEn = k.replace(/[ê°€-í£]/g,'').trim();
    return (onlyEn||k);
  }
}
function textKO(card){
  return (card.meaning||"").trim();
}
function autoSpeak(card){
  if(!card) return;
  if(ctx.domain==="english"){
    // ì˜ì–´ëŠ” ENë§Œ ìë™
    const t = textEN(card);
    if(t) speak(t, 'en-US');
  }else{
    // íŒŒì´ì¬/íŒë‹¤ìŠ¤/SQLì€ í‚¤ì›Œë“œ(ko) ìë™
    const t = card.keyword || "";
    if(t) speak(t, 'ko-KR');
  }
}
$sayEN.addEventListener("click", ()=>{ const c=ctx.deck[ctx.idx]; speak(textEN(c),'en-US'); });
$sayKO.addEventListener("click", ()=>{ const c=ctx.deck[ctx.idx]; speak(textKO(c),'ko-KR'); });

/* ----------------------------
   í‚¤ë³´ë“œ(ëª¨ë°”ì¼ ì™¸ë¶€ í‚¤ë³´ë“œ í¬í•¨)
----------------------------- */
window.addEventListener("keydown",(e)=>{
  if(e.key==="ArrowRight") $next.click();
  else if(e.key==="ArrowLeft") $prev.click();
  else if(e.key===" ") { e.preventDefault(); $auto.click(); }
});

/* ----------------------------
   PWA SW ë“±ë¡
----------------------------- */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
}
</script>
</body>
</html>
